<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ThreeJS CanvasRender 粒子系统</title>
    <script type="text/javascript" src="../lib/three.js"></script>
    <script type="text/javascript" src="../lib/three-projector.js"></script>
    <script type="text/javascript" src="../lib/three-canvas-render.js"></script>
    <script type="text/javascript" src="../lib/TweenMax.min.js"></script>
    <script type="text/javascript" src="../lib/stats.min.js"></script>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style type="text/css">
        body{
            margin:0;
            padding:0;
        }
        div#canvas-frame {
            cursor: pointer;
            width:100%;
            height:100%;
            background-color: #EEEEEE;
        }
    </style>
</head>
<body onload="threeStart();">
<div id="canvas-frame"></div>
<script>
    'use strict';
    var renderer;//渲染器
    var width;//页面宽度
    var height;//页面高度
    var stats;//性能检测
    window.requestAnimFrame = (function() {//如果有变化则可能还需要requestAnimationFrame刷新
        return window.requestAnimationFrame ||
                window.mozRequestAnimationFrame ||
                window.webkitRequestAnimationFrame ||
                window.msRequestAnimationFrame ||
                window.webkitRequestAnimationFrame;
    })();
    //开始
    function threeStart() {
        initThree();
        initCamera();
        initScene();
        initLight();
        initObject();
        render();
    }
    //根据页面宽度和高度创建渲染器，并添加容器中
    function initThree() {
        width = window.innerWidth;
        height = window.innerHeight;
        renderer = new THREE.CanvasRenderer();
        renderer.setPixelRatio( window.devicePixelRatio );
        renderer.setSize(width, height);
        var container = document.getElementById('canvas-frame');

        container.appendChild(renderer.domElement);

        stats = new Stats();
        container.appendChild( stats.dom );
    }
    //创建相机，并设置正方向和中心点
    var camera;
    function initCamera() {
        camera = new THREE.PerspectiveCamera(45, width / height, 1, 1000);
        camera.position.x = 0;
        camera.position.y = 0;
        camera.position.z = 600;
        camera.up.x = 0;//正方向
        camera.up.y = 1;
        camera.up.z = 0;
        camera.lookAt({
            x : 0,
            y : 0,
            z : 0
        });
    }
    //创建场景，后续元素需要加入到场景中才会显示出来
    var scene;
    function initScene() {
        scene = new THREE.Scene();
    }
    //创建光线
    var light;
    function initLight() {
        light = new THREE.AmbientLight(0xfefefe);
        scene.add(light);
    }
    //创建展示场景所需的各种元素
    var group
    function initObject() {
        group = new THREE.Group();
        scene.add( group );
        //创建一个球型用作最后的形状
        var geometry = new THREE.SphereGeometry( 500, 32, 32 );
        var vl = geometry.vertices.length;//球型的所有顶点
        for ( var i = 0; i < vl; i++ ) {
            //为每个点附上材质
            var material = new THREE.SpriteCanvasMaterial( {
                color: Math.random() * 0x808008 + 0x808080,
                program: program
            } );
            var particle = new THREE.Sprite( material );
            particle.position.x = 0;
            particle.position.y = 0;
            particle.position.z = 0;
            particle.scale.x = particle.scale.y = Math.random() * 6;//圆形的x和y同时缩放相应倍数
            TweenMax.to(
                particle.position,
                1,
                //最终坐标增加适当随机变化，来保证最终效果不是一个很规则的球型
                {x:geometry.vertices[i].x+Math.random()*100,y:geometry.vertices[i].y+Math.random()*100,z:geometry.vertices[i].z+Math.random()*100,delay:0.5,}
            );
            group.add( particle );
        }
    }
    //渲染
    function render(){
        renderer.clear();
        renderer.render(scene, camera);
        stats.update();
        window.requestAnimFrame(render);
    }

    //画点
    function program( context ) {
        context.beginPath();
        context.arc( 0, 0, 0.5, 0, Math.PI*2, true );
        context.fill();
    };
</script>
</body>
</html>